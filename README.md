


# Welcome to BrightEyes-TTM!

The **BrightEyes-TTM is an open-source project** which consists in a **data-acquisition card** able to implement the so-called photon time-tagging acquisition mode with a **time resolution of ~30ps** designed for microscopy and based on a **commercial FPGA Xilinx Kintex-7**.

The BrightEyes-TTM project born as an offshoot of the BrighEyes project founded by the ERC in 2018 (Consolidator Grant, N. 818699). The principal aim of the BrightEyes-TTM project is to give to any microscopy laboratory the possibility to implement and further develop single-photon microscopy. The second aim is to trigger the interest of the microscopy community, and establish the BrigthEyes-TTM as a new standard for single-photon laser scanning microscopy (LSM) experiments.

---

**THE COMPLETE DOCUMENTATION IS AVAILABLE ON https://brighteyes-ttm.readthedocs.io/**

---

# Introduction

The BrightEyes-TTM project [\[1\]](https://doi.org/10.1101/2021.10.11.463950) born as an offshoot of the BrighEyes project founded by the ERC in 2018 ([Consolidator Grant, N. 818699](https://vicidominilab.github.io/brighteyes/)). The principal aim of the BrightEyes-TTM project is to give to any microscopy laboratory the possibility to implement and further develop single-photon microscopy. The second aim is to trigger the interest of the microscopy community, and establish the BrigthEyes-TTM as a new standard for single-photon laser scanning microscopy (LSM) experiments.

:::{figure} img/TTM-BrightEyes-Minimal.png
:align: center
:alt: Assembly
:width: 50%

Fig. 1 - The BrightEyes Time-Tagging Module
:::

```{note}
**In this documentation you can find everything you need to build and further modify the BrightEyes-TTM in your lab.**
```
**The source code, the open hardware, python libraries and example are available in GitHub at the following address:**
[github.com/VicidominiLab/BrightEyes-TTM version 2.0](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0)


```{note}
**There are two version of BrightEyes-TTM. The article on arXiv is referred to the version v1.0, the article published is refered to the version v2.0.**
```
The legacy version (v1.0) is available in the branch on GitHub
[github.com/VicidominiLab/BrightEyes-TTM version 1.0](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v1.0)

The BrightEyes-TTM mainly consists in a data-acquisition (DAQ) card able to implement the so-called photon time-tagging acquisition mode (Fig. 2).

## Time-tagging

:::{figure} img/TT_Principle.jpg
:align: center
:alt: Principle
:width: 50%

Fig. 2 - Time-tagging principle.
:::

The time-tagging (TT) mode allows recording individual events and labelling each of them with a temporal signature. Typically this temporal signature denotes the delay time of the events in respect to the beginning of the experiment (absolute time). The BrightEyes TT module (TTM) is able to tag three different class of events: The photon events, i.e., a photon is registered by the detector which delivery a digital signal to the module; The sync laser events, i.e., the synchronisation signal delivered by a pulsed laser; the reference events, i.e., a signal generated by another component of the experimental setup (e.g., an actuator, a laser modulator). Starting from these temporal signatures it is possible to derive many other different temporal information. For example, for each photons event it is possible to derive the so-called start-stop time, which describe the delay of the photon event in respect to the successive sync laser event. Very important, together with the temporal signatures, the BrightEyes-TTM records also the number of the channels ( *ch* ) or inputs ( *l* ) associated to the photon or reference event. In the single-photon laser microscopy applications of our BrightEyes-TTM, the channel for the photon event describes the element of the single-photon-avalanche diode (SPAD) array detector which collected the photon, thus it can be considered a spatial signature.

## Main components

The BrightEyes-TTM is based on a [field-programmable-gate-array](https://en.wikipedia.org/wiki/Field-programmable_gate_array) (FPGA), which allows implementing a series of [time-to-digital converters (TDCs)](https://en.wikipedia.org/wiki/Time-to-digital_converter), i.e., the building block of the TTM. Current BrightEyes-TTM implementation allows to temporally tag single-photon events with respect to the laser sync (i.e., the start-stop time) - with 30 ps precision - and the reference events (such as pixel, line and frame signals) - with 4.2 ns precision. Because the BrightEyes-TTM is a [VHDL](https://en.wikipedia.org/wiki/VHDL)/[Verilog](https://en.wikipedia.org/wiki/Verilog)-based open-access project, it can be upgraded, modified, and customized by all the microscopy-makers.

The TTM can transfer data to a personal computer (PC) via USB 3.0 cable and can be connected to a fluorescence LSM setup, as a passive plug-n-play device, thanks to a custom interfacing connector board. As shown in the data processing examples below, the BrightEyes-TTM allows for fluorescence spectroscopy, fluorescence lifetime imaging microscopy (FLIM) \[2\], and for fluorescence lifetime correlation spectroscopy (FLFS) experiments \[3\]. More in general, the TTM can be used to fully explore the great momentum in the development of new bi-dimensional or one-dimensional asyncronous read-out SPAD array detectors \[3,4\].


The BrightEyes-TTM is composed by three main parts: the FPGA evaluation board ([Xilinx® KC705 Evaluation board](https://www.xilinx.com/products/boards-and-kits/ek-k7-kc705-g.html)); the FX3 data transmission chip ([EZ-USB® FX3™ SuperSpeed Explorer Kit](https://www.cypress.com/documentation/development-kitsboards/cyusb3kit-003-ez-usb-fx3-superspeed-explorer-kit) and [FMC Interconnect Board for the EZ-USB® FX3™ SuperSpeed Explorer Kit](https://www.cypress.com/documentation/development-kitsboards/cyusb3acc-005-fmc-interconnect-board-ez-usb-fx3-superspeed)); a custom-made I/Os SMA-FMC daugther connector card. The three part need to be assembled (Fig. 3) following the instruction below (expand the Assembly Instuctions). Both the FX3 data transmission chip and the I/Os FMC daugther card easily interlock to the main Xilinx® FPGA board.

:::{figure} img/Kintex7-TTM.jpg
:align: center
:alt: AssemblyK7
:width: 50%

Fig. 3 - BrightEyes-TTM assembly.
:::

## Specifications
|                                        |                              |
|----------------------------------------|------------------------------|
| Single shot precision *                | **30 ps**                    |
| Time bin width                         | user defined (default 43 ps) |
| Time range **                          | not limited by hardware      |
| Maximum laser sync rate                | 80 MHz                       |
| Dead time                              | 1 / 240 MHz = ~ 4.2ns        |
| Differential non-linearity             | ~ 6 % RMS                    |
| Input channels with 30 ps precision    | 21, 25, (49 under testing)   |
| Input channels with < 4.2 ns precision | 3                            |
| Laser SYNC channels                    | 1                            |
|                                        |                              |

\* Gaussan fitting sigma value

\*\* Tested at 200 ns (5 MHz), 100 ns (10 MHz), 50 ns (20 MHz), 25 ns (40 MHz), 12.5 ns (80 MHz)
# Getting started
In this section you will find the hardware and software needed to build and run the BrightEyes-TTM.

## Microscope
The BrightEyes-TTM can be connected to commercial or custom imaging microscopes as long as they provide the following synchronization outputs:
|   |    |
|------|-----|
| Laser SYNC | needed |
| Pixel | needed <br /> for imaging |
| Line | needed <br /> for imaging |
| Frame | needed <br /> for imaging |

...and of course the detector signals.

The FPGA synchronization inputs have LVTTL level so if you need to adapt the signal see "MPD NIM 2 TTL" and "8xDigiBuffer" in the Hardware list here below.

### Detector
The BrightEyes-TTM channel inputs supports either LVTTL or LVDS level input signals. Depending from the type of signal you will need to use a specific firmware and a specific version of "I/O to FMC adapter board" in the Hardware list here below. This means that the BrightEyes-TTM can use as input channel PMT (+CFD) or APD, and of course SPAD array detectors. BrightEyes-TTM has been designed for SPAD prototype with 25 channel (LVTTL levels) and for commercial SPAD with 49 channel (LVDS levels). 

## Hardware
Here the list of the hardware requirments.

|      |     |     |
|------|-----|-----|
|PC  <br /> Minimum Requirements:  <br /> USB 3.0, >= 1.5 GHz CPU, <br /> >= 16 GB RAM, SSD hard disk, |  commercial   | needed <br /> (strongly suggested<br /> Linux OS)   |
|[Xilinx Kintex-7 KC705 evaluation board](FPGABoard.md)| commercial  | |
|[Cypress FX3™ SuperSpeed Explorer Kit](FMCAdapter.md)| commercial  | |
|[I/O to FMC adapter board](IOConnectorBoard.md) | custom |      |
|[MPD NIM 2 TTL](NIM2TTL.md) | commercial| strongly suggested   |
|[8xDigiBuffer](DigiBuffer.md) | custom | strongly suggested | 

## Firmware
Here the list of the firmwares needed to use the BrightEyes-TTM.

|      |     |
|------|-----|
|[Cypress FX3™ SuperSpeed Explorer Kit](USB3.md)| firmware external  |
|[BrightEyes-TTM](FPGABoard.md) | firmware custom and open-source  |

## Software

```{note}
The software to acquire data and the script to analyze tham was developed is Linux native. Even if it should run in Windows 10 / 11 we strongly suggest to use it on a Linux distribution Debian derivate (Debian 11, Ubuntu 20.04 LTS, Linux Mint 20.3 etc...).
```

### Data Acquisition
|      |     |
|------|-----|
| [datareceiver](datareceiver.md) | Linux / Windows |


### Data Analysis libraries
The `libttp` is needed in order to convert the raw data from the BrightEyes-TTM acquisition to a dataframe or a HDF5 file. The `spadffs` are needed instead for perform FCS analysis. More details here [BrightEyes-TTM libraries](dataprocessing.md).


### Data Processing (Python Notebooks)
The data processing example are given here:
|      |     |
|------|-----|
| [BrightEyes-TTM dataprocessing](dataprocessing.md) | Python Notebook examples |

# Hardware
In the table below you can find the complete list of all the needed hardware components for builing the BrightEyes-TTM.

```{toctree}
FPGABoard
FMCAdapter
IOConnectorBoard
```

## Optional hardware parts

```{toctree}
NIM2TTL
DigiBuffer
```

## How to assemble / setup the harware

The Xilinx® KC705 Evaluation board, the Cypress® FX3™ SuperSpeed Explorer Kit and the connector card can be easily stacked together, using FMC connectors, as shown below (Fig. 3). I/Os connections are also labeled for a more intuitive assembly and mapped in the [I/O pins table](IOConnectorBoard.md) which shows the correspondence between inputs (typically the digital output from the SPAD array detector elements, named photon chaneels) and the connection pins. For a correct use of the BrightEyes-TTM the [dip switches](https://en.wikipedia.org/wiki/DIP_switch) in the orange BOX (always Fig.3) should be all set to the OFF position.

The Cypress® FX3™ SuperSpeed Explorer Kit board interlock into the FMC-LPC connector block. While the I/Os connector cards is connected to the FMC-HPC connector.

:::{figure} TTM_Assembled.jpg
:align: center
:alt: Assembly
:width: 3500

Fig.3 - BrightEyes-TTM detailed assembly.
:::

In the current application the BrightEyes-TTM provides the duplication of the central channel. 

|  Firmware  version |  Conn. | SPAD | Board    |  Central PX       |  Dupl. output on | 
| ------------ |----------- | ----------- | ----------------- |  -----------| -----------| 
|  Single-Ended inputs | SMA/SMB | 25 ch. | [I/O SMA/B-to-FMC adapter board](pinout5x5.md)  | PX10 (J13) |J17| 
|  Differentials inputs | HPC |49 ch. | [I/O 7x7SPAD-to-FMC](pinout7x7.md)  | PX24  | J9| 


## PC requirements

```{eval-rst}
.. list-table::
   :header-rows: 1

   * -
     -
   * - PC interface
     - USB 3.0 SuperSpeed
   * - PC requirements
     - min. 1.5 GHz CPU clock, min. 8 GB RAM memory (suggested >=64 GB), SSD hard disk
   * - Operating system
     - Linux (native) / Windows (ported)
```
# BrightEyes-TTM Mainboard

**(based on Kintex-7 evaluation board)**

BrightEyes-TTM is based on a commercially available and low cost [field-programmable-gate-array (FPGA)](https://en.wikipedia.org/wiki/Field-programmable_gate_array) evaluation Board (Fig.1), equipped with a state-of-the-art FPGA (the [Kintex 7](https://www.xilinx.com/products/silicon-devices/fpga/kintex-7.html), XC7K325T-2FFG900C) and a series of [I/Os connectors](docs/img/TTM_Assembly.png) granting an easy interface of the board with the laser scanning microscope controller, the detector(s) and the personal computer.


Xilinx® FPGA Kintex-7 KC705 Evaluation Board

- *Brand:* Xilinx®
- *Product code:* EK-K7-KC705-G
- *Link to the product:* <https://www.xilinx.com/products/boards-and-kits/ek-k7-kc705-g.html>


The BrightEyes-TTM project has been designed, synthesed and implementated with the software Xilinx Vivado 2017.4 more info [Xilinx Vivado Design Suite](https://www.xilinx.com/products/design-tools/vivado.html). After having downloaded and installed [Vivado Design Suite](https://www.xilinx.com/products/design-tools/vivado.html) (Xilinx FPGA Programming software environment) the Xilinx FPGA evaluation card can be directly programmed with a precompiled firmware available here below. 
The source code VHDL/Verilog is available on the GitHub repository [BrightEyes-TTM FPGA VHDL/Verilog code](https://github.com/VicidominiLab/BrightEyes-TTM/v2.0/main/FPGA/ttm/hdl)


:::{figure} img/KC705_FPGA.png
:align: center
:alt: Xilinx FPGA Board
:width: 50%

Fig.1 - Xilinx FPGA Board
:::

## BrightEyes-TTM Firmware
(ttmfirmware)=

The current firmware (.bit files) ready to flash the Xilinx KC705 Kintex-7 Evaluation board are available here:
- [BrightEyes-TTM FPGA firmware](https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/FPGA/ttm/project/ttm.runs/impl_1/top_single_ended.bit): 25 channels, single-ended inputs, new protocol (v.2.0)
- [BrightEyes-TTM FPGA firmware](https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/FPGA/ttm/project/ttm.runs/impl_1/top_diff.bit): 25 channels, differential inputs, new protocol (v.2.0)


Legacy firmware:
- [BrightEyes-TTM FPGA firmware](https://github.com/VicidominiLab/BrightEyes-TTM/raw/v1.0/FPGA/ttm/project/ttm.runs/impl_1/top.bit): 21 channels, single-ended inputs, old protocol (v.1.0)

If you want modify the project or you want know more about the BrightEyes-TTM firmware design see the [BrightEyes-TTM FPGA architecture](architecture.md).
# FMC-to-USB Adapter

FMC Interconnect Board for the EZ-USB® FX3™, to connect a Xilinx® FPGA board with the EZ-USB® FX3™ SuperSpeed Explorer Kit

The USB-FMC needs two component the interconnection board and the USB-FX3 chip.

:::{figure} img/USBchip_adapter_assembly.PNG
:align: center
:alt: I/Os SMA-FMC connector Board
:width: 100%

Fig.1 - Assembly for CYUSB3ACC-005 FMC Interconnect Board and the EZ-USB® FX3™ SuperSpeed Explorer Kit
:::

## Interconnect board

- *Brand:* Cypress®
- *Product code:* CYUSB3ACC-005
- *Link to the product:* <https://www.cypress.com/documentation/development-kitsboards/cyusb3acc-005-fmc-interconnect-board-ez-usb-fx3-superspeed>

The [CYUSB3ACC-005 FMC Interconnect Board for the EZ-USB® FX3™ SuperSpeed Explorer Kit](https://www.cypress.com/documentation/development-kitsboards/cyusb3acc-005-fmc-interconnect-board-ez-usb-fx3-superspeed) is used to interconnect with the Xilinx® KC705 Evaluation kit FPGA board with the EZ-USB® FX3™ SuperSpeed Explorer Kit.

Follow the [Quick start guide](https://www.cypress.com/file/133861/download) or Fig.1 below on how to interconnect the different components.

## USB data chip

EZ-USB® FX3™ SuperSpeed Explorer Kit

- *Brand:* Cypress®
- *Product code:* CYUSB3KIT-003 EZ-USB
- *Link to the product:* <https://www.infineon.com/cms/en/product/evaluation-boards/cyusb3kit-003/>


The BrightEyes-TTM design transmits the data to the PC via USB 3.0, a [FX3-based board](https://github.com/VicidominiLab/BrightEyes-TTM/v2.0/main/boards/USB3.0/mainboard) (Fig.1 - Cypress SuperSpeed Explorer kit board, CYUSB3KIT) connected through an [adapter card (CYUSB3ACC)](USB3.md) to LPC-FMC connector of the Kintex-7 evaluation board. In order to use the FX3 chip, a dedicated module in the FPGA was developed. It has a simple interface (essentially FIFO with a data-valid flag) for the data transmission and it manages the FX3 control signals and the data-bus. The module was designed to work with the FX3 programmed with the SF_streamIN firmware part of the [AN65974](https://www.infineon.com/cms/en/design-support/software/code-examples/usb-controllers-code-examples/usb-super-speed-code-examples/) example provided by Cypress.

The [Cypress SuperSpeed Explorer kit Board](https://github.com/VicidominiLab/BrightEyes-TTM/v2.0/main/boards/USB3.0/mainboard) and its [FMC adapter connector card](USB3.md) for the FPGA board are available at these links:

- [Cypress SuperSpeed Explorer kit](https://www.cypress.com/documentation/development-kitsboards/cyusb3kit-003-ez-usb-fx3-superspeed-explorer-kit)
- [FMC adapter card](https://www.cypress.com/documentation/development-kitsboards/cyusb3acc-005-fmc-interconnect-board-ez-usb-fx3-superspeed)
 

#### Firmware

The Cypress SuperSpeed Explorer kit main board has to be programmed, to work with TTM FPGA firmware, with the SF_streamIN, which is part of the Cypress Application Note "AN65974 - Designing with the EZ-USB™ FX3". The file AN65974.zip which contains the **firmware SF_streamIN.img can be downloaded from this** [link](https://www.infineon.com/cms/en/design-support/software/code-examples/usb-controllers-code-examples/usb-super-speed-code-examples/). This allow for the acquired data to be trasmitted to a host-PC.

:::{figure} img/FX3_Cypress.PNG
:align: center
:alt: Cypress SuperSpeed Explorer kit
:width: 50%

Fig.1 - Cypress SuperSpeed Explorer kit
:::

Follow the [Quick start guide](https://www.cypress.com/file/133861/download) or Fig.2 below on how to interconnect the different components.

:::{figure} img/USBchip_adapter_assembly.PNG
:align: center
:alt: I/Os SMA-FMC connector Board
:width: 50%

Fig.2 - Assembly for CYUSB3ACC-005 FMC Interconnect Board and the EZ-USB® FX3™ SuperSpeed Explorer Kit
:::

[CYUSB3KIT-003 EZ-USB® FX3™ SuperSpeed Explorer Kit](https://www.cypress.com/documentation/development-kitsboards/cyusb3kit-003-ez-usb-fx3-superspeed-explorer-kit)

[Programming guide](https://www.cypress.com/file/133836/download) from page #20

Programming firmware [link](https://www.infineon.com/dgdl/Infineon-AN65974-ApplicationNotes-v17_00-EN.zip?fileId=8ac78c8c7cdc391c017d073967ed5de5)
# I/Os adapters & Pinout

```{toctree}
pinout5x5
pinout7x7
```

## Pinout synchronization

```{eval-rst}
.. list-table::
   :header-rows: 1

   * - SMA on Xilinx KC705 board (.xdc)
     - Input
   * - J11
     - Frame
   * - J12
     - Laser SYNC
   * - J13
     - Pixel
   * - J14
     - Line
```
## SMA/SMB-to-FMC board
FMC daugther card to interface the BrightEyes-TTM with external photon-signals on SMA (or SMB) connectors. The input signals of this board are single-ended with impedance 50 Ohm. 

- *Brand:* *custom-built*
- *Product code:* *custom-built*
- **Gerber File:** [Gerber_SMA_FMC.zip](https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/IOconnectorBoard/Gerber_SMA_FMC.zip)

The BrightEyes-TTM interfaces with the photon-signals thanks to a custom-built I/0s FMC daughter card (Fig.1) connected via the FPGA mezzanine connector (FMC-HPC). In principle, if needed, also the I/0s FMC daughter card can be modfied, further developed and yet manufactured to adapt the BrightEyes-TTM to any type of LSM signals.

:::{figure} img/SMA_FMC_IO_daughtercard.PNG
:align: center
:alt: I/Os SMA-FMC connector Board
:width: 50%

Fig.1 - I/Os SMA-FMC connector Board
:::

The custom-built I/0s FMC daughter card interlocks with the Xilinx KC705 Evaluation kit as shown in Fig.2 below:

:::{figure} img/ConnectorBoard_connections.PNG
:align: center
:alt: ConnectorBoard_connections
:width: 50%

Fig.2 - I/Os SMA-FMC connector Board
:::

In this repository the following files are available for builing a SMA-FMC connector board:

```{eval-rst}
.. list-table::
   :header-rows: 1

   * - Name
     - Where to get
   * - Connector card gerber files
     - `Gerber_SMA_FMC.zip <https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/IOconnectorBoard/Gerber_SMA_FMC.zip>`_
   * - Connector card circuit schematic
     - `SMA_FMC-schematic.pdf <https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/IOconnectorBoard/SMA_FMC-schematic.pdf>`_
   * - Connector card pcb
     - `SMA_FMC-pcb.pdf <https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/IOconnectorBoard/SMA_FMC-pcb.pdf>`_
   * - Connector card 3D model
     - `SMA_FMC-3D.pdf <https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/IOconnectorBoard/SMA_FMC-3D.pdf>`_

```

Starting from these general open-source design files the FMC connector board can be engineered for interfacing the TTM to any type of detectors or microscope setups.

Check the tables below for the connection map:

### Pinout I/Os SMA/B-to-FMC board

|   **SPAD 5x5 PX**   | **SMA/B-FMC** | **CH  (VHDL)** |       **NET**      | **HPC** | **XDC** |
|:-------------------:|:-------------:|:--------------:|:------------------:|:-------:|:-------:|
|          1          |       J2      |        0       |   FMC_HPC_LA20_P   |   G21   |   E19   |
|          2          |       J7      |        1       |   FMC_HPC_LA20_N   |   G22   |   D19   |
|          3          |      J30      |        2       |   FMC_HPC_LA06_P   |   C10   |   H30   |
|          5          |      J10      |        3       |   FMC_HPC_LA06_N   |   C11   |   G30   |
|          6          |      J24      |        4       |   FMC_HPC_LA10_P   |   C14   |   D29   |
|          7          |       J8      |        5       |   FMC_HPC_LA10_N   |   C15   |   C30   |
|          8          |      J33      |        6       |   FMC_HPC_LA14_P   |   C18   |   B28   |
|          9          |      J28      |        7       |   FMC_HPC_LA14_N   |   C19   |   A28   |
|        **10**       |    **J37**    |      **8**     | **FMC_HPC_LA27_P** | **C26** | **C19** |
|          11         |      J16      |        9       |   FMC_HPC_LA27_N   |   C27   |   B19   |
|          12         |       J5      |       10       |   FMC_HPC_LA05_P   |   D11   |   G29   |
|          13         |      J34      |       11       |   FMC_HPC_LA05_N   |   D12   |   F30   |
|          14         |      J19      |       12       |   FMC_HPC_LA09_P   |   D14   |   B30   |
|          15         |       J9      |       13       |   FMC_HPC_LA09_N   |   D15   |   A30   |
|          16         |      J13      |       14       |   FMC_HPC_LA13_P   |   D17   |   A25   |
|          17         |      J23      |       15       |   FMC_HPC_LA13_N   |   D18   |   A26   |
|          18         |      J22      |       16       |   FMC_HPC_LA23_P   |   D23   |   B22   |
|          19         |      J27      |       17       |   FMC_HPC_LA23_N   |   D24   |   A22   |
|          21         |      J32      |       18       |   FMC_HPC_LA26_P   |   D26   |   B18   |
|          22         |      J11      |       19       |   FMC_HPC_LA26_N   |   D27   |   A18   |
|          23         |      J25      |       20       |   FMC_HPC_LA03_P   |    G9   |   H26   |
|          0          |      J20      |       21       |   FMC_HPC_LA03_N   |   G10   |   H27   |
|          4          |      J39      |       22       |   FMC_HPC_LA08_P   |   G12   |   E29   |
|          24         |      J29      |       23       |   FMC_HPC_LA08_N   |   G13   |   E30   |
|          20         |      J35      |       24       |   FMC_HPC_LA02_P   |    H7   |   H24   |
|                     |      J40      |       25       |   FMC_HPC_LA02_N   |    H8   |   H25   |
|                     |      J15      |       26       |   FMC_HPC_LA04_P   |   H10   |   G28   |
|                     |       J4      |       27       |   FMC_HPC_LA04_N   |   H11   |   F28   |
|                     |      J14      |       28       |   FMC_HPC_LA12_P   |   G15   |   C29   |
|                     |       J3      |       29       |   FMC_HPC_LA12_N   |   G16   |   B29   |
|                     |      J18      |       30       |   FMC_HPC_LA16_P   |   G18   |   B27   |
|                     |      J38      |       31       |   FMC_HPC_LA16_N   |   G19   |   A27   |
|                     |      J12      |                |   FMC_HPC_LA22_P   |   G24   |   C20   |
| **PX10 duplicated** |    **J17**    |                | **FMC_HPC_LA22_N** | **G25** | **B20** |
|                     |       J1      |                |   FMC_HPC_LA25_P   |   G27   |   G17   |
|                     |       J6      |                |   FMC_HPC_LA25_N   |   G28   |   F17   |
|                     |      J21      |                |   FMC_HPC_LA29_P   |   G30   |   C17   |
|                     |      J26      |                |   FMC_HPC_LA29_N   |   G31   |   B17   |
|                     |      J31      |                |   FMC_HPC_LA31_P   |   G33   |   G22   |
|                     |      J36      |                |   FMC_HPC_LA31_N   |   G34   |   F22   |
## SPAD7x7-to-FMC board
FMC daugther card to interface the BrightEyes-TTM with external photon-signals from a commercial 7x7 SPAD (49 channels) detector. The input signals of this board are differential LVDS signals. 

- *Brand:* *custom-built*
- *Product code:* *custom-built*
- BOM and docs: [7x7SPAD_FMC](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/boards/TTM7x7Adapter/docs)
- **Gerber File:** [Gerber_7x7SPAD_FMC.zip](https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/TTM7x7Adapter/TTM7x7Adapter_gerber.zip)


:::{figure} img/3DViewF.png
:align: center
:width: 50%

Fig.1 - I/Os 7x7SPAD-to-FMC connector Board (Front)
:::

:::{figure} img/3DViewB.png
:align: center
:width: 50%

Fig.1 - I/Os 7x7SPAD-to-FMC connector Board (Back)
:::

### Pinout I/Os 7x7SPAD-to-FMC board

| **CH (VHDL)**       |     **DET**     | **CONN** | **NAME HPC** | **FPGA** |
|---------------------|:---------------:|:--------:|:------------:|:--------:|
|          0          | OUT1_P          | D11      | LA05_P       | G29      |
|          0          | OUT1_N          | D12      | LA05_N       | F30      |
|          1          | OUT2_P          | H13      | LA07_P       | E28      |
|          1          | OUT2_N          | H14      | LA07_N       | D28      |
|          2          | OUT3_P          | E6       | HA05_P       | F15      |
|          2          | OUT3_N          | E7       | HA05_N       | E16      |
|          3          | OUT4_P          | J9       | HA07_P       | B14      |
|          3          | OUT4_N          | J10      | HA07_N       | A15      |
|          4          | OUT5_P          | H7       | LA02_P       | H24      |
|          4          | OUT5_N          | H8       | LA02_N       | H25      |
|          5          | OUT6_P          | D8       | LA01_P       | D26      |
|          5          | OUT6_N          | D9       | LA01_N       | C26      |
|          6          | OUT7_P          | E2       | HA01_P       | H14      |
|          6          | OUT7_N          | E3       | HA01_N       | G14      |
|          7          | OUT8_P          | C22      | LA18_P       | F21      |
|          7          | OUT8_N          | C23      | LA18_N       | E21      |
|          8          | OUT9_P          | C18      | LA14_P       | B28      |
|          8          | OUT9_N          | C19      | LA14_N       | A28      |
|          9          | OUT10_P         | J15      | HA14_P       | J16      |
|          9          | OUT10_N         | J16      | HA14_N       | H16      |
|          10         | OUT11_P         | G6       | LA00_P       | C25      |
|          10         | OUT11_N         | G7       | LA00_N       | B25      |
|          11         | OUT12_P         | K10      | HA06_P       | D14      |
|          11         | OUT12_N         | K11      | HA06_N       | C14      |
|          12         | OUT13_P         | F7       | HA04_P       | F11      |
|          12         | OUT13_N         | F8       | HA04_N       | E11      |
|          13         | OUT14_P         | G9       | LA03_P       | H26      |
|          14         | OUT15_P         | G21      | LA20_P       | E19      |
|          14         | OUT15_N         | G22      | LA20_N       | D19      |
|          15         | OUT16_P         | D17      | LA13_P       | A25      |
|          15         | OUT16_N         | D18      | LA13_N       | A26      |
|          16         | OUT17_P         | K16      | HA17_P       | G13      |
|          16         | OUT17_N         | K17      | HA17_N       | F13      |
|          17         | OUT18_P         | K7       | HA02_P       | D11      |
|          17         | OUT18_N         | K8       | HA02_N       | C11      |
|          18         | OUT19_P         | J6       | HA03_P       | C12      |
|          18         | OUT19_N         | J7       | HA03_N       | B12      |
|          19         | OUT20_P         | H10      | LA04_P       | G28      |
|          19         | OUT20_N         | H11      | LA04_N       | F28      |
|          20         | OUT21_P         | C10      | LA06_P       | H30      |
|          20         | OUT21_N         | C11      | LA06_N       | G30      |
|          21         | OUT22_P         | F16      | HA15_P       | H15      |
|          21         | OUT22_N         | F17      | HA15_N       | G15      |
|          22         | OUT23_P         | D23      | LA23_P       | B22      |
|          22         | OUT23_N         | D24      | LA23_N       | A22      |
|          23         | OUT24_P         | E18      | HA20_P       | K13      |
|          23         | OUT24_N         | E19      | HA20_N       | J13      |
|        **24**       | **OUT25_P**     | **E9**   | **HA09_P**   | **F12**  |
|        **24**       | **OUT25_N**     | **E10**  | **HA09_N**   | **E13**  |
|          25         | OUT26_P         | K13      | HA10_P       | A11      |
|          25         | OUT26_N         | K14      | HA10_N       | A12      |
|          26         | OUT27_P         | F4       | HA00_P       | D12      |
|          26         | OUT27_N         | F5       | HA00_N       | D13      |
|          27         | OUT28_P         | D14      | LA09_P       | B30      |
|          27         | OUT28_N         | D15      | LA09_N       | A30      |
|          28         | OUT29_P         | D20      | LA17_P       | F20      |
|          28         | OUT29_N         | D21      | LA17_N       | E20      |
|          29         | OUT30_P         | K22      | HA23_P       | L12      |
|          29         | OUT30_N         | K23      | HA23_N       | L13      |
|          30         | OUT31_P         | G24      | LA22_P       | C20      |
|          30         | OUT31_N         | G25      | LA22_N       | B20      |
|          31         | OUT32_P         | H19      | LA15_P       | C24      |
|          31         | OUT32_N         | H20      | LA15_N       | B24      |
|          32         | OUT33_P         | F10      | HA08_P       | E14      |
|          32         | OUT33_N         | F11      | HA08_N       | E15      |
|          33         | OUT34_P         | C14      | LA10_P       | D29      |
|          33         | OUT34_N         | C15      | LA10_N       | C30      |
|          34         | OUT35_P         | J12      | HA11_P       | B13      |
|          34         | OUT35_N         | J13      | HA11_N       | A13      |
|          35         | OUT36_P         | F19      | HA19_P       | H11      |
|          35         | OUT36_N         | F20      | HA19_N       | H12      |
|          36         | OUT37_P         | H25      | LA21_P       | A20      |
|          36         | OUT37_N         | H26      | LA21_N       | A21      |
|          37         | OUT38_P         | J21      | HA22_P       | L11      |
|          37         | OUT38_N         | J22      | HA22_N       | K11      |
|          38         | OUT39_P         | J18      | HA18_P       | K14      |
|          38         | OUT39_N         | J19      | HA18_N       | J14      |
|          39         | OUT40_P         | E12      | HA13_P       | L16      |
|          39         | OUT40_N         | E13      | HA13_N       | K16      |
|          40         | OUT41_P         | H16      | LA11_P       | G27      |
|          40         | OUT41_N         | H17      | LA11_N       | F27      |
|          41         | OUT42_P         | G12      | LA08_P       | E29      |
|          41         | OUT42_N         | G13      | LA08_N       | E30      |
|          42         | OUT43_P         | E15      | HA16_P       | L15      |
|          42         | OUT43_N         | E16      | HA16_N       | K15      |
|          43         | OUT44_P         | H22      | LA19_P       | G18      |
|          43         | OUT44_N         | H23      | LA19_N       | F18      |
|          44         | OUT45_P         | K19      | HA21_P       | J11      |
|          44         | OUT45_N         | K20      | HA21_N       | J12      |
|          45         | OUT46_P         | G15      | LA12_P       | C29      |
|          45         | OUT46_N         | G16      | LA12_N       | B29      |
|          46         | OUT47_P         | C26      | LA27_P       | C19      |
|          46         | OUT47_N         | C27      | LA27_N       | B19      |
|          47         | OUT48_P         | F13      | HA12_P       | C15      |
|          47         | OUT48_N         | F14      | HA12_N       | B15      |
|          48         | OUT49_P         | G18      | LA16_P       | B27      |
|          48         | OUT49_N         | G19      | LA16_N       | A27      |
|                     |                 |          |              |          |
|                     | VREF1           | G27      | LA25_P       | G17      |
|                     | VREF0           | G28      | LA25_N       | F17      |
|                     | EN_SPAD         | G30      | LA29_P       | C17      |
|                     |                 |          |              |          |
|                     | SDA             | C31      | HPC_IIC_SDA  | IIC MUX  |
|                     | SCL             | C30      | HPC_IIC_SCL  | IIC MUX  |
|                     |                 |          |              |          |
|                     | **IIT ADAPTER** |          |              |          |
|                     | J2              | H28      | LA24_P       | A16      |
|                     | J3              | H29      | LA24_N       | A17      |
|                     | J4              | H31      | LA28_P       | D16      |
|                     | J5              | H32      | LA28_N       | C16      |
|                     | J6              | H34      | LA30_P       | D22      |
|                     | J7              | H35      | LA30_N       | C22      |
|                     | J8              | H37      | LA32_P       | D21      |
| **PX24 Duplicated** | J9              | H38      | LA32_N       | C21      |
# Hardware
In the table below you can find the complete list of all the needed hardware components for builing the BrightEyes-TTM.

```{toctree}
FPGABoard
FMCAdapter
IOConnectorBoard
```

## Optional hardware parts

```{toctree}
NIM2TTL
DigiBuffer
```

## How to assemble / setup the harware

The Xilinx® KC705 Evaluation board, the Cypress® FX3™ SuperSpeed Explorer Kit and the connector card can be easily stacked together, using FMC connectors, as shown below (Fig. 3). I/Os connections are also labeled for a more intuitive assembly and mapped in the [I/O pins table](IOConnectorBoard.md) which shows the correspondence between inputs (typically the digital output from the SPAD array detector elements, named photon chaneels) and the connection pins. For a correct use of the BrightEyes-TTM the [dip switches](https://en.wikipedia.org/wiki/DIP_switch) in the orange BOX (always Fig.3) should be all set to the OFF position.

The Cypress® FX3™ SuperSpeed Explorer Kit board interlock into the FMC-LPC connector block. While the I/Os connector cards is connected to the FMC-HPC connector.

:::{figure} TTM_Assembled.jpg
:align: center
:alt: Assembly
:width: 3500

Fig.3 - BrightEyes-TTM detailed assembly.
:::

In the current application the BrightEyes-TTM provides the duplication of the central channel. 

|  Firmware  version |  Conn. | SPAD | Board    |  Central PX       |  Dupl. output on | 
| ------------ |----------- | ----------- | ----------------- |  -----------| -----------| 
|  Single-Ended inputs | SMA/SMB | 25 ch. | [I/O SMA/B-to-FMC adapter board](pinout5x5.md)  | PX10 (J13) |J17| 
|  Differentials inputs | HPC |49 ch. | [I/O 7x7SPAD-to-FMC](pinout7x7.md)  | PX24  | J9| 


## PC requirements

```{eval-rst}
.. list-table::
   :header-rows: 1

   * -
     -
   * - PC interface
     - USB 3.0 SuperSpeed
   * - PC requirements
     - min. 1.5 GHz CPU clock, min. 8 GB RAM memory (suggested >=64 GB), SSD hard disk
   * - Operating system
     - Linux (native) / Windows (ported)
```
# MPD NIM 2 TTL

MPD NIM 2 TTL

- *Brand:* Micro Photon Devices
- *Product code:* NIM2TTL
- *Link to the product:* <http://www.micro-photon-devices.com/Products/Instrumentation/NIM2TTL-Converter>


This is a commercial device which we use for converting the laser clock signal from NIM levels to TTL levels.
# 8xDigiBuffer

I/O multichannel (8x) digital buffer to match the impedance of external reference signals with the input impedance of the Xilinx® KC705 Evaluation kit

- *Brand:* *custom-built*
- *Product code:* *custom-built*
- **Gerber File:** [8xDigiBuffer_Gerber.zip](https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/8xDigiBuffer/files/DigiBuff8_rev2_GerberFiles.zip)

The 8xDigiBuffer is a custom built circuital component used as signal level (voltage) and impedance matching device. It is used as front-end logic to adapt and buffer external signals to the LVTTL 50 Ohm requirements of the  Xilinx® KC705 Evaluation kit.

The 8xDigiBuffer accomodates 8x inputs and it is capable of translating the input voltage levels into  LVTTL 50 Ohm in real-time.

In the current application and implementation, the 8xDigiBuffer, is used to make the pixel, line and frame clocks in a suitable form to be read bythe Xilinx® KC705 Evaluation kit SMA ports (Fig. 1).

:::{figure} img/8xDigiBuffer_connections.PNG
:align: center
:alt: I/Os SMA-FMC connector Board
:width: 600

Fig.1 - 8xDigiBuffer connections.
:::

At the links in the table below all the needed information for building a 8xDigiBuffer:

```{eval-rst}
.. list-table::
   :header-rows: 1

   * - Name
     - Where to get
   * - 8xDigiBuffer gerber soucer files
     - `DigiBuff8_rev2_GerberFiles.zip <https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/8xDigiBuffer/files/DigiBuff8_rev2_GerberFiles.zip>`_
   * - 8xDigiBuffer build of materials
     - `BOM_DIGIBUFF8_rev2.xlsx <https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/8xDigiBuffer/doc/BOM_DIGIBUFF8_rev2.xlsx>`_
   * - 8xDigibuffer circuit schematic
     - `DigiBuff8_rev2_sch.pdf <https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/8xDigiBuffer/doc/DigiBuff8_rev2_sch.pdf>`_
   * - 8xDigibuffer pcb views
     - `DigiBuff8_rev2_pcb.pdf <https://github.com/VicidominiLab/BrightEyes-TTM/raw/v2.0/boards/8xDigiBuffer/doc/DigiBuff8_rev2_pcb.pdf>`_
```
# Data Receiver

There are two version of the BrightEyes-TTM data receiver. The "Old Protocol" version for the firmware (v1.0)  and the "New Protocol" version for the firmware (v2.0). The data receiver the libraries _libusb_ and save the stream of data from USB 3.0 to a raw file. We suggest to use the Linux version but it is available also a Windows porting. Link to the folder in the repository [dataReceiver](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/dataReceiver).


## DataReceiver Linux


### Requirements

```
sudo apt-get install libusb-dev libusb-1.0-0-dev
```

### How to compile?

```
(Legacy Protocol - Bright-TTM firmware v1.0)
gcc "dataReceiver.c" -O2 -g `pkg-config libusb-1.0 --libs --cflags`  -lpthread -o "dataReceiver"
```
```
("new" Protocol - Bright-TTM firmware >=v2.0)
gcc "dataReceiver-newProt.c" -O2 -g `pkg-config libusb-1.0 --libs --cflags`  -lpthread -o "dataReceiver-newProt"
```

### How to run?

The software crash if the subfolder **data/** is it not present in the folder where the **dataReceiver** is executed.
Create the  **data/** folder:

```
mkdir data
```

Then you can run

```
(Legacy Protocol - Bright-TTM firmware v1.0)
./dataReceiver
```

or 

```
("new" Protocol - Bright-TTM firmware >=v2.0)
./dataReceiver-newProt
```

:::{figure} img/dataReceiver/dataReceiverNew.png
:align: center
:width: 100%
Fig. The dataReceiver-newProt running in Linux
:::




---

## DataReceiver Windows (only firmware v1.0)


The DataReceiverW is the porting of the DataReceiver for Linux to Windows. It based on the libusb-win32 driver and it is in an experimental phase.
The installation of the libusb-win32 drivers can be done with the tool Zadig. It is a software that allows to install and to switch different drivers on the USB devices in Windows. It can be downloaded the site https://zadig.akeo.ie/ .

### How to install libusb-32 driver in Windows 10

* Download Zadig from  https://zadig.akeo.ie/ 
* Run Zadig and grant the permission to change your system.

:::{figure} img/dataReceiver/zadig_0.png
:align: center
:width: 50%
:::


:::{figure} img/dataReceiver/zadig_1.png
:align: center
:width: 100%
:::

:::{figure} img/dataReceiver/zadig_2.png
:align: center
:width: 100%
:::


Select in the menu **Options --> List All Devices**

:::{figure} img/dataReceiver/zadig_3.png
:align: center
:width: 100%
:::


Select in the list of devices **FX3** 

:::{figure} img/dataReceiver/zadig_4.png
:align: center
:width: 100%
:::


Select in the scrollbox **libusb-win32** and click on **"Replace Driver"** and wait for the installation

:::{figure} img/dataReceiver/zadig_5.png
:align: center
:width: 100%
:::

:::{figure} img/dataReceiver/zadig_6.png
:align: center
:width: 100%
:::

Now the libusb-win32 drivers should be correctly installed.

### How to run DataReceiverW

:::{figure} img/dataReceiver/datawriterW.png
:align: center
:width: 100%
:::


The **dataReceiverW.exe** executable file is present in the repository at the following link [dataReceiverW (v1)](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/dataReceiver/windows/v1/bin) and [dataReceiverW-newProt (v2)](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/dataReceiver/windows/v2/bin). It is a command-line interface CLI software, so it is suggested to run into a Command Prompt (cmd.exe). To run correctly the dataReceiverW needs the library **libpthread.dll** and **libusb-1.0.dll**. The software crash if the subfolder **data\\** is it not present in the folder where the dataReceiverW is executed. 
# Data processing

In this section you will find example of data processing. 

Data is acquired in a RAW format from the TTM using the same data protocol for all the possible and different applications. Then depending on the type of information/application needed is unpacked, calibrated and reconstructed (Fig.1).

:::{figure} img/DataProcessing.PNG
:align: center
:width: 100%

Fig.1 - Data processing procedure
:::

In order to be able to reconstruct and process the data streamed by the BrightEyes-TTM python libraries have to be previously installed in the host-processing computer. On a normal desktop PC, the Jupyter Notebooks examples have from a couple of minutes up-to tenths of minutes of execution time.

## Examples (firmware v2.0)

Before run the notebooks you need to install the libraries libttp and spadffs (v2.0)

### libttp and spadffs (v2.0)
In order to read the raw data from the BrightEyes-TTM acquisition `libttp` is required.
In the v2.0 you can easily install with the following command. Use an enviroment manager like venv

```
pip install libttp 
```

Moreover to run correctly the BrightEyes-TTM Notebook examples `spadffs` is needed too.

```
pip install -r https://raw.githubusercontent.com/VicidominiLab/libspadffs/ttm/requirements.txt
pip install git+https://github.com/VicidominiLab/libspadffs.git@ttm

(note you need to install "git" before run the last command, if you use a Conda enviroment use "conda install git")
```
```{note}
`libttp` uses Cython libraries. If you want to run in Windows you need to install Microsoft Build Tools. In Linux this is not required.
```

### Notebooks
Before run the notebooks you need to install the libraries libttp and spadffs (v2.0)

#### TCSPC histogram

Thanks to the [TCSPC histogram reconstruction Jupyter Notebook example](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/notebooks/v2/TCSPC_Histogram_reconstruction.ipynb) it is possible to reconstruct and look the data from a simple spectroscopy point of view by building the TCSPC histogram for all the acquired channels.

#### Imaging

If pixel,line and frame clocks are connected to the BrightEyesTTM then intensity images as well as FLIM images can be reconstructed too. The [image reconstruction Jupyter Notebook example](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/notebooks/v2/Image_reconstruction.ipynb) shows all the steps to reconstruct a **4D dataset (x,y,t,ch)** and visualize microscopy images.

#### FCS

If the final goal of the measurement is to retrieve information from the correlation curve the [FCS Jupyter Notebook example](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/notebooks/v2/FCS.ipynb) shows how to calculate the correlation curve.

#### ISM & FLIM-Phasor analysis

This Jupyter notebook example can be used for implementing the pixel reassignment algorithm for image scanning microscopy (ISM) applications and for performing FLIM-phasor analysis with time-resolved data. After having used the image reconstruction Jupyter Notebook example for reconstructing a 4D dataset (x,y,t,ch) it is possible to feed this dataset into the [ISM & FLIM-phasor notebook](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/notebooks/v2/ISM_Decay_Reconstruction.ipynb). NB - time alignment of the fluorescence lifetime decays is required, accross the different available channels (ch), before feeding a 4D dataset into this notebook.


## Examples  (legacy firmware v1.0)

Before run the notebooks you need to install the libraries libttp and spadffs (v1.0)

### libttp and spadffs (legacy v1.0)
In order to install the libttp, spadffs version v1.0. Follow the links below for downloading and installing the required librares.

```{note}
`libttp` uses Cython libraries. If you want to run in Windows you need to install Microsoft Build Tools. In Linux this is not required.
```
- TTM library for reconstructing and calibrating time-tagging data streamet by the BrightEyes-TTM to the host-PC - [lipttp](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v1.0/dataProcessing/libs/libttp)
- FFS library for reconstructing the correlation curve and implementing FCS - [spad_ffs](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v1.0/dataProcessing/libs/spad_ffs)


In order to give the user some preliminary tools to process, reconstruct and use the acquired TTM data we developed 3 main examples using Jupyter Notebook and we provide the associated examples dataset on [Zenodo](https://doi.org/10.5281/zenodo.4912656):

---

### Notebooks

#### TCSPC histogram

Thanks to the [TCSPC histogram reconstruction Jupyter Notebook example](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/notebooks/v1/TCSPC_Histogram_reconstruction.ipynb) it is possible to reconstruct and look the data from a simple spectroscopy point of view by building the TCSPC histogram for all the acquired channels.

#### Imaging

If pixel,line and frame clocks are connected to the BrightEyesTTM then intensity images as well as FLIM images can be reconstructed too. The [image reconstruction Jupyter Notebook example](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/notebooks/v1/Image_reconstruction.ipynb) shows all the steps to reconstruct a **4D dataset (x,y,t,ch)** and visualize microscopy images.

#### FCS

If the final goal of the measurement is to retrieve information from the correlation curve the [FCS Jupyter Notebook example](https://github.com/VicidominiLab/BrightEyes-TTM/tree/v2.0/notebooks/v1/FCS.ipynb) shows how to calculate the correlation curve.

#### ISM & FLIM-Phasor analysis

This Jupyter notebook example can be used for implementing the pixel reassignment algorithm for image scanning microscopy (ISM) applications and for performing FLIM-phasor analysis with time-resolved data. After having used the image reconstruction Jupyter Notebook example for reconstructing a 4D dataset (x,y,t,ch) it is possible to feed this dataset into the [ISM & FLIM-phasor notebook](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/notebooks/v1/ISM_Decay_Reconstruction_BrightEyes-TTM.ipynb). NB - time alignment of the fluorescence lifetime decays is required, accross the different available channels (ch), before feeding a 4D dataset into this notebook.

#### Data Source (Zenodo)

The data used in these examples can be downloaded from the link:

| Name | Format | Link &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; | Associated example dataset on Zenodo | 
| ------ | ------ | ------ | ----- |
| TSCPC Histogram |  RAW legacy (v1.0) | [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.4912656.svg)](https://doi.org/10.5281/zenodo.4912656) | **Fluorescence_Spectroscopy_Dataset_40MHz** | 
| Imaging | RAW legacy (v1.0)  | [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.4912656.svg)](https://doi.org/10.5281/zenodo.4912656) | **FLIM_512x512pixels_dwelltime250us_Dataset_40MHz** |
| FCS | RAW legacy (v1.0) | [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.4912656.svg)](https://doi.org/10.5281/zenodo.4912656) | **FCS_scanfcs_Dataset_40MHz** | 
| TSCPC Histogram | RAW (v2.0)  | [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.6782161.svg)](https://doi.org/10.5281/zenodo.6782161) | **FLIM_80MHz_512x512pixel_120FOV_pixeldwelltime200us.ttr** |
| Imaging | RAW (v2.0)  | [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.6782161.svg)](https://doi.org/10.5281/zenodo.6782161) | **FLIM_80MHz_512x512pixel_120FOV_pixeldwelltime200us.ttr** |
| FCS | RAW (v2.0) |  [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.6782161.svg)](https://doi.org/10.5281/zenodo.6782161) | **FCS_SpotVariation_80MHz.ttr** | 





# FPGA architecture

The BrightEyes-TTM implementation was conceived and designed having in mind the fluorescence applications thus providing a good compromise between cost, photon-timing precision and resolution, temporal range, electronics dead-time, maximum photon-flux. The low FPGA resource in the current implementation ensures the highly scalability of the architecture, potentially enabling more channels and, in general, new applications. We chose an FPGA approach to grant both quick prototyping and versatility, and to give the miscroscopy community the posibility of further modifing the TTM depending on future and always-evolving needs.

:::{figure} img/BrightEyesTTM_architecture.PNG
:align: center
:alt: BrightEyes TTM architecture
:width: 50%

Fig.2 - BrightEyes TTM architecture
:::

VHDL source code TTM architecture components:

- [Hit filter](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/hdl/input_filter.vhd) - The hit-filter component is engineered and deployed to shape the incoming photons and sync signal lengths based on the sampling FPGA clock period and, at the same time, for generating a toggle signal event (the photon or sync enable signal) for each detected photon or laser pulse event.
- [Flash TDC](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/hdl/tdc_module.vhd) - The core constituent of the flash TDC module is a tapped delay line (TDL). The TDL is made up by a series of small delay elements (CARRY4 elements for the Kintex-7 FPGA used - for more info check page 43 of [7 Series FPGAs Configurable Logic Block User Guide](https://www.xilinx.com/support/documentation/user_guides/ug474_7Series_CLB.pdf) joined in a chain architecture and is used to delay an input (photon/START) signal with respect to a reference-sampling FPGA digital clock. Whitin the Flash TDC module also a thermometer-to-binary encoder (T2B) is embedded: a dedicated FPGA circuit is needed to interpret and decode the TDL output data. The T2B converts the TDL readout into a binary format allowing for a more effective data registration in terms of memory resources utilisation.
- [FIFO memory](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/hdl/fifo_iit.v) - First-In First-Out (FIFO) internal FPGA memory used to store the registered photons and laser sync events before sending their info out to a host processing unit.
- [Data interface module](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/hdl/to_fxr_workaround.v) - Module component that allows the data to be transfered from the FPGA to the  EZ-USB® FX3™ SuperSpeed Explorer Kit.
  * In the v2 version there is a [datapreparation](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/hdl/datapreparation_new.vhd) and [datapreparation_zerosuppression](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/hdl/datapreparation_new_with_zerosuppression.vhd). The first packs the data according to the v2 protocol and the second module avoid to transmit the channel data which are not hit.
  * In the v1 version the data are packet directly in the [Flash TDC](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/hdl/tdc_module.vhd).

```{note}
**Input map**
The version v2.0 have two `top` module. In the Vivado project one must be disabled and the other one must be enabled and selected as Top module:
- [top_diff.vhd](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/xdc/top_diff.vhd) (which needs [top_diff.xdc](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/xdc/top_diff.xdc) enabled - for differential inputs - designed the [SPAD7x7-to-FMC adapter board](pinout7x7.md) )
- [top_single_ended.vhd](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/xdc/top_single_ended.vhd) (which needs [top_single_ended.xdc](https://github.com/VicidominiLab/BrightEyes-TTM/blob/v2.0/FPGA/ttm/xdc/top_single_ended.xdc) enabled - for single-ended inputs - designed for [SMA/SMB-to-FMC adapter board](pinout5x5.md) )
```

The BrightEyes-TTM architecture (Fig.2) combines N+1 (N = 25 photon channels in this implementation) tapped delay lines (TDLs) and a coarse counter running at 240 MHz to obtain N fine TDCs with tens of picoseconds precision (for the start-stop time of each photon channel), and M coarse TDCs with a nanosecond precision (M = 3 reference channels in this implementation).

# Authors

[Molecular Microscopy & Spectroscopy, Istituto Italiano di Tecnologia](<https://vicidominilab.github.io/>)

```{image} img/MMS_logo.png
:alt: MMS_logo
:width: 80
```

* [Alessandro Rossetta](https://vicidominilab.github.io/team/AR/) [^1],[^2],[^3],[^6]
* [Eli Slenders](https://vicidominilab.github.io/team/ES/) [^6]
* [Mattia Donato](https://vicidominilab.github.io/team/MD/) [^6]
* [Sabrina Zappone](https://vicidominilab.github.io/team/SZ/) [^1],[^3]
* [Francesco Fersini](https://vicidominilab.github.io/team/FF/) [^1],[^3]
* [Francesco Diotalevi](https://www.iit.it/people-details/-/people/francesco-diotalevi) [^4]
* Luca Lanzanò [^2] [^5]
* [Sami Koho](https://vicidominilab.github.io/team/SVK/) [^1]
* [Giorgio Tortarolo](https://vicidominilab.github.io/team/GT/) [^1]
* [Marco Crepaldi](https://www.iit.it/people-details/-/people/marco-crepaldi) [^4]
* [Eleonora Perego](https://vicidominilab.github.io/team/EP/) [^1]

and

* [**Giuseppe Vicidomini**](https://vicidominilab.github.io/team/GV/) [^1],[^0],[*] 
 
[^0]:Corresponding author 
[^1]:Molecular Microscopy and Spectroscopy, Istituto Italiano di Tecnologia, Via Enrico Melen 85 Bldg. B, 16152, Genoa, Italy
[^2]:Nanoscopy and NIC@IIT, Istituto Italiano di Tecnologia, Via Enrico Melen 85 Bldg. B, 16152, Genoa, Italy
[^3]:Dipartimento di Informatiche, Bioingegneria, Robotica e Ingegneria dei Sistemi, University of Genoa, Via All'Opera Pia 13, 16145, Genoa, Italy
[^4]:Electronic Design Laboratory, Istituto Italiano di Tecnologia, Via Enrico Melen 85 Bldg. B, 16152, Genoa, Italy
[^5]:Dipartimento di Fisica e Astronomia, Università di Catania, Via S. Sofia 64, 95123, Catania, Italy
[^6]:These authors contributed equally to this work

## Contributions
* G.V. conceived the idea and designed the research;
* G.V. supervised the research;
* A.R., M.D., with the support from F.D. and M.C., wrote the firmware for the time-tagging module and the data-receiver;
* M.D., with support from A.R., wrote the operational software;
* A.R., E.S., M.D., S.K., and G.T. wrote the imaging analysis software;
* E.S., M.D., and L.L. wrote the FFS analysis software;
* A.R. and M.D. characterized and validated the TTM module with the test-bench architecture;
* E.S. and F.F. built the single-photon microscopes;
* S.Z. prepared the cell samples. E.S. and E.P., with support from A.R., performed the single-photon microscopy experiments;
* E.P. designed, implemented, and analyzed all the FLFS experiments;
* A.R., E.S., M.D., E.P., S.K., G.T., and G.V., analyzed the data;
* A.R., M.D., and G.V. built the GitHub repository;
* G.V., E.S. and E.P., with support from A.R. and M.D., wrote the manuscript with edits from all authors.

# Acknowledgements
This research was supported by Fondazione San Paolo, “Observation of bio-molecular processes in live-cell with nanocamera”, No. EPFD0098 (E.S. and G.V.), by the European Research Council, Bright Eyes, No. 818699 (G.T. and G.V.), and by the European Union's Horizon 2020 research and innovation programme under the Marie Sk1odowska-Curie grant agreement no. 890923 (SMSPAD) (E.S.). We thank Prof. Alberto Diaspro and Dr. Paolo Bianchini (Nanoscopy \& NIC@IIT, Istituto Italiano di Tecnologia) for useful discussions; Dr. Michele Oneto (Nikon Imaging Center) and Marco Scotto (Molecular Microscopy and Spectroscopy, Istituto Italiano di Tecnologia) for support on the experiments; Dr. Andrea Barberis and Dr. Enrica Petrini (Synaptic Plasticity of Inhibitory Networks, Istituto Italiano di Tecnologia) for providing the primary hippocampal cells; Alessandro Barcellona (Electronic Design Laboratory, Istituto Italiano di Tecnologia) for design and implementation of the custom-made buffer; Prof. Alberto Tosi, Prof. Federica Villa, Dr. Mauro Buttafava (Politecnico di Milano), Dr. Marco Castello, and Dr. Simonluca Piazza (Istituto Italiano di Tecnologia and Genoa Instruments) for useful initial discussions in the time-to-digital design and for the realization of the single-photon-avalanche-diode detector array.



# Copyright

Time-Tagging Module
Copyright (c) 2021, Molecular Microscopy & Spectroscopy,
Fondazione Istituto Italiano di Tecnologia. All rights reserved.
<https://vicidominilab.github.io>

# License

The Time-Tagging Module (TTM) is an aggregation of different parts with different licenses. See details in [LICENSE.md](LICENSE.md) file.  Unless otherwise stated, they are licensed under a CC-BY-NC 4.0, Creative Commons Attribution-NonCommercial 4.0 International License.

```{image} https://licensebuttons.net/l/by-nc/4.0/88x31.png
:alt: 'License: CC BY-NC 4.0'
:target: https://creativecommons.org/licenses/by-nc/4.0/
```

In addition to the terms of the license, **we ask to acknowledge the use
of the time-tagging module in scientific articles by citing**:

```
The BrightEyes-TTM: an Open-Source Time-Tagging Module for Single-Photon Microscopy
A. Rossetta, E. Slenders, M. Donato, E. Perego, F. Diotalevi, L. Lanzano', S. V. Koho, G. Tortarolo, M.Crepaldi, G. Vicidomini
bioRxiv 2021.10.11.463950; doi: https://doi.org/10.1101/2021.10.11.463950
```

# Contact us

Do you need help to build up your time-tagging module? Do you have comments or questions? Do not hesitate to contact us at <mailto:giuseppe.vicidomini@iit.it>.

# References

\[1\] A. Rossetta, E. Slenders, M. Donato, E. Perego, F. Diotalevi, L. Lanzano', S. V. Koho, G. Tortarolo, M. Crepaldi, G. Vicidomini bioRxiv 2021.10.11.463950; doi: <https://doi.org/10.1101/2021.10.11.463950>

\[2\] M. Castello, G. Tortarolo, M. Buttafava, T. Deguchi, F. Villa, S. Koho, L. Pesce, M. Oneto, S. Pelicci, L. Lanzanó, P. Bianchini, C. J. R. Sheppard, A. Diaspro, A. Tosi, and G. Vicidomini, A robust and versatile platform for image scanning microscopy enabling super-resolution FLIM, *Nat. Methods* , 16: 175–178 (2019), [https://doi.org/10.1038/s41592-018-0291-9](https://doi.org/10.1038/s41592-018-0291-9)

\[3\] E. Slenders, M. Castello, M. Buttafava, F. Villa, A. Tosi, L. Lanzano, S. V. Koho, and G. Vicidomini, Confocal-based fluorescence fluctuation spectroscopy with a SPAD array detector, *Light Sci. Appl.* , 10: 31 (2021), [https://doi.org/10.1038/s41377-021-00475-z](https://doi.org/10.1038/s41377-021-00475-z)

\[4\] M. Buttafava, F. Villa, M. Castello, G. Tortarolo, E. Conca, M. Sanzaro, S. Piazza, P. Bianchini, A. Diaspro, F. Zappa, G. Vicidomini, and A. Tosi, SPAD-based asynchronous-readout array detectors for image-scanning microscopy, *Optica* , 7: 755-765 (2020), [https://doi.org/10.1364/OPTICA.391726](https://doi.org/10.1364/OPTICA.391726)

\[5\] S. V. Koho, E. Slenders, G. Tortarolo, M. Castello, M. Buttafava, F. Villa, E. Tcarenkova, M. Ameloot, P. Bianchini, C. J. R. Sheppard, A. Diaspro, A. Tosi, and G. Vicidomini, Two-photon image-scanning microscopy with SPAD array and blind image reconstruction, *Biomed. Opt. Express* ,  11(6): 2905-2924 (2020), [https://doi.org/10.1364/BOE.374398](https://doi.org/10.1364/BOE.374398)
